<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Payment Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <!-- Load jsPDF and autoTable from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <h1>Student Payment Manager</h1>

  <div class="form-container">
    <label for="studentName">Student Name:</label>
    <select id="studentName">
      <option value="">-- Select Student --</option>
    </select>

    <label for="mobileNumber">Mobile Number:</label>
    <select id="mobileNumber">
      <option value="">-- Select Mobile --</option>
    </select>

    <label for="seatNumber">Seat Number:</label>
    <input type="text" id="seatNumber" placeholder="Enter Seat Number">

    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate" placeholder="Start Date">

    <label for="month">Month:</label>
    <input id="month" type="number" min="1" max="12" step="1" placeholder="Enter no. of months paid">

    <label for="dueDate">Due Date:</label>
    <input type="date" id="dueDate">

    <label for="fees">Fees:</label>
    <input type="number" id="fees" placeholder="Fees">

    <label for="paymentDate">Payment Date:</label>
    <input type="date" id="paymentDate">

    <label for="mode">Payment Mode:</label>
    <select id="mode">
  <option value="">-- Select Mode --</option>
  <option value="Online">Online</option>
  <option value="Cash">Cash</option>
  <option value="Both">Both</option>
</select>


    <label for="remark">Remark:</label>
    <input type="text" id="remark" placeholder="Enter Remark">

    <div class="button-group">
  <button onclick="savePayment()">Save</button>
  <button onclick="editPayment()">Edit</button>
  <button onclick="deletePayment()">Delete</button>
  <button onclick="cancelForm()">Cancel</button>
  <button onclick="backupData()">🔄 Backup</button>
  <button onclick="restoreData()">♻️ Restore</button>
</div>

<!-- 👇 Add this after button group 👇 -->
<div id="shareOptions" style="display: none; margin-top: 10px;">
  <button onclick="sendWhatsApp()">📲 Send WhatsApp</button>
  <button onclick="sendSMS()">✉️ Send SMS</button>
  <button onclick="hideShareButtons()">❌ Cancel</button>
</div>

  </div>

  <hr>

  <div class="history-container">
    <h2>View Payment History</h2>
    <label for="historyStudent">Select Student:</label>
    <select id="historyStudent" onchange="showHistory()">
      <option value="">-- Select Student --</option>
    </select>
    <div id="paymentHistory"></div>
    <button onclick="downloadPDF()">📄 Download</button>
    <button onclick="downloadAllPaymentsPDF()">📄 Download All</button>
    <!-- Your Download Button -->
    <button onclick="openMonthPicker()">📅 Download Monthly Report</button>

    <!-- Hidden Month Picker -->
    <input type="month" id="monthPicker" style="display:none;" />

  </div>

  <!-- All JavaScript here -->
  <script>
let lastSavedMobile = "";
let lastGeneratedMessage = "";

    window.addEventListener("DOMContentLoaded", async function () {
      const students = [
  { name: "Paras Nayak", mobile: "9109474221" },
  { name: "Supriya Singh", mobile: "8882383925" },
  { name: "Khushboo Kushwaha", mobile: "9243142882" },
  { name: "Pradeep Yadav", mobile: "6265023322" },
  { name: "Anshuman Patel", mobile: "9243994181" },
  { name: "Mragendra Patel", mobile: "6261324663" },
  { name: "Vaishanavi Mehra", mobile: "7725848220" },
  { name: "Sanjay Mirotha", mobile: "9179120130" },
  { name: "Anand Thakur", mobile: "7047408289" },
  { name: "Ajay Baraskar", mobile: "9174870614" },
  { name: "Prateek Kant", mobile: "7770968933" },
  { name: "Vidhi Patel", mobile: "9329382695" },
  { name: "Raj Kalosiya", mobile: "9109598404" },
  { name: "Priya Suryavanshi", mobile: "9165132297" },
  { name: "Aapka Manan", mobile: "9669727432" },
  { name: "Raj Kumar Meena", mobile: "8085657884" },
  { name: "Jayesh Dhakad", mobile: "7045706142" },
  { name: "HarshWardhan", mobile: "8287722711" },
  { name: "Anvita Chouhan", mobile: "7987630835" },
  { name: "Vipin Patel", mobile: "9753653902" },
  { name: "Jay Prakash Yadav", mobile: "8839462926" },
  { name: "Ayush Pandey", mobile: "8878050539" },
  { name: "Nitesh Ahirwar", mobile: "7489624124" },
  { name: "Aditya Mehra", mobile: "9340373010" },
  { name: "Aryan Soni", mobile: "8871522818" },
  { name: "Himanshu Sen", mobile: "9893348965" },
  { name: "Ravi Patidar", mobile: "8964006763" },
  { name: "Divi Chouhan", mobile: "9522400701" },
  { name: "Rajdeep Vishwakarma", mobile: "7770996528" },
  { name: "Abhishek Sharma", mobile: "8770062508" },
  { name: "Govind Pawar", mobile: "7909448937" },
  { name: "Sonu Jatav", mobile: "8103128342" },
  { name: "Rishu Gupta", mobile: "7000332823" },
  { name: "Shalini Singroli", mobile: "6232124825" },
  { name: "Divya", mobile: "96260497674" },
  { name: "Priyanka Chouhan", mobile: "9179452283" },
  { name: "Krishna Patel", mobile: "8269749288" },
  { name: "Riya Rahangdale", mobile: "7999426292" },
  { name: "Mahendra Singh Chouhan", mobile: "7970130730" },
  { name: "Ayushi Jain", mobile: "7909569496" },
  { name: "Khusal Rajurkar", mobile: "7049999632" },
  { name: "Harsh Malviya", mobile: "6263346265" },
  { name: "Ravi Singh", mobile: "6269087903" },
  { name: "Sachin Verma", mobile: "9424866452" },
  { name: "Pooja Chakraboty", mobile: "9926125035" },
  { name: "Somesh Dhakad", mobile: "9754138691" },
  { name: "Shriram Dhakad", mobile: "6260025818" },
  { name: "Pawan Pandit", mobile: "7089542287" },
  { name: "Shriyanshu Sahu", mobile: "8982798576" },
  { name: "Vikas Pawar", mobile: "6266955434" },
  { name: "Vivek Patel", mobile: "6260025818" },
  { name: "Ashutosh Mishra", mobile: "8103572465" }
      ];

      const studentSelect = document.getElementById("studentName");
      const mobileSelect = document.getElementById("mobileNumber");
      const historySelect = document.getElementById("historyStudent");

      students.forEach(s => {
        let option1 = document.createElement("option");
        option1.value = s.name;
        option1.text = s.name;
        studentSelect.add(option1);

        let option2 = document.createElement("option");
        option2.value = s.mobile;
        option2.text = s.mobile;
        mobileSelect.add(option2);

        let option3 = document.createElement("option");
        option3.value = s.name;
        option3.text = s.name;
        historySelect.add(option3);
      });

      studentSelect.addEventListener("change", () => {
        const selectedName = studentSelect.value;
        const student = students.find(s => s.name === selectedName);
        if (student && student.mobile) {
          mobileSelect.value = student.mobile;
        }
      });

      const { jsPDF } = window.jspdf;
      window.jsPDFGlobal = jsPDF;
    });

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startDate").addEventListener("change", calculateDueDate);
      document.getElementById("month").addEventListener("change", calculateDueDate);
    });

    let selectedStudent = null;
    let selectedPaymentIndex = null;

    function calculateDueDate() {
      const startDateStr = document.getElementById("startDate").value;
      const admissionMonth = parseInt(document.getElementById("month").value);
      if (!startDateStr || isNaN(admissionMonth)) return;
      const startDate = new Date(startDateStr);
      startDate.setMonth(startDate.getMonth() + admissionMonth);
      const year = startDate.getFullYear();
      const month = (startDate.getMonth() + 1).toString().padStart(2, '0');
      const day = startDate.getDate().toString().padStart(2, '0');
      document.getElementById("dueDate").value = `${year}-${month}-${day}`;
    }
function generateMessage(name, mobile, fees, months, paymentDate, startDate, dueDate, mode, remark) {
  return `📚 **WISDOM LIBRARY**

Hello **${name}** 👋

We’re happy to inform you that **your payment of ₹${fees} for ${months} month(s) has been successfully received on ${paymentDate}.** ✅

🗓️ **Period:** ${startDate} → ${dueDate}  
💳 **Mode of Payment:** ${mode}${remark ? `\n📝 **Remark:** ${remark}` : ''}

🙏 Thank you for your **payment and continued trust in Wisdom Library.**`;
}




function sendWhatsApp() {
  if (!lastSavedMobile || !lastGeneratedMessage) {
    alert("Mobile number or message not found!");
    return;
  }

  const mobile = lastSavedMobile.replace(/\D/g, '');
  const message = encodeURIComponent(lastGeneratedMessage);
  const url = `https://wa.me/91${mobile}?text=${message}`;
  window.open(url, "_blank");
}




function sendSMS() {
  if (!lastSavedMobile || !lastGeneratedMessage) {
    alert("Mobile number or message not found!");
    return;
  }

  const mobile = lastSavedMobile.replace(/\D/g, '');
  const message = encodeURIComponent(lastGeneratedMessage);
  const smsUrl = `sms:+91${mobile}?body=${message}`;
  window.open(smsUrl, "_blank");
}


function showShareButtons() {
  document.getElementById("shareOptions").style.display = "block";
}

function hideShareButtons() {
  document.getElementById("shareOptions").style.display = "none";
}


   function savePayment() {
  const studentName = document.getElementById("studentName").value;
  const mobileNumber = document.getElementById("mobileNumber").value;
  const seatNumber = document.getElementById("seatNumber").value;
  const startDate = document.getElementById("startDate").value;
  const admissionMonth = document.getElementById("month").value;
  const dueDate = document.getElementById("dueDate").value;
  const fees = document.getElementById("fees").value;
  const paymentDate = document.getElementById("paymentDate").value;
  const mode = document.getElementById("mode").value;
  const remark = document.getElementById("remark").value;

  if (!studentName || !paymentDate) {
    alert("Student name and payment date are required.");
    return;
  }

  const payment = {
    seatNumber, mobileNumber, startDate, admissionMonth,
    dueDate, fees, paymentDate, mode, remark
  };

  let allPayments = JSON.parse(localStorage.getItem("payments")) || {};
  if (!allPayments[studentName]) {
    allPayments[studentName] = [];
  }
  allPayments[studentName].push(payment);
  localStorage.setItem("payments", JSON.stringify(allPayments));

  // ✅ Save mobile and message before clearing form
  lastSavedMobile = mobileNumber;
  lastGeneratedMessage = generateMessage(
  studentName,
  mobileNumber,
  fees,
  admissionMonth,
  formatDate(paymentDate),
  formatDate(startDate),
  formatDate(dueDate),
  mode,
  remark
);


  // ✅ Show share buttons
  showShareButtons();

  // ✅ Clear form
  document.querySelectorAll(".form-container input, .form-container select").forEach(el => el.value = "");

  alert("Payment saved successfully!");
}


    function populateForm(payment) {
      document.getElementById("studentName").value = selectedStudent;
      document.getElementById("mobileNumber").value = payment.mobileNumber;
      document.getElementById("seatNumber").value = payment.seatNumber;
      document.getElementById("startDate").value = payment.startDate;
      document.getElementById("month").value = payment.admissionMonth;
      document.getElementById("dueDate").value = payment.dueDate;
      document.getElementById("fees").value = payment.fees;
      document.getElementById("paymentDate").value = payment.paymentDate;
      document.getElementById("mode").value = payment.mode;
      document.getElementById("remark").value = payment.remark;
    }

    function editPayment() {
      if (selectedStudent === null || selectedPaymentIndex === null) {
        alert("Select a payment from history to edit.");
        return;
      }

      const updatedPayment = {
        seatNumber: document.getElementById("seatNumber").value,
        mobileNumber: document.getElementById("mobileNumber").value,
        startDate: document.getElementById("startDate").value,
        admissionMonth: document.getElementById("month").value,
        dueDate: document.getElementById("dueDate").value,
        fees: document.getElementById("fees").value,
        paymentDate: document.getElementById("paymentDate").value,
        mode: document.getElementById("mode").value,
        remark: document.getElementById("remark").value
      };

      let allPayments = JSON.parse(localStorage.getItem("payments")) || {};
      allPayments[selectedStudent][selectedPaymentIndex] = updatedPayment;
      localStorage.setItem("payments", JSON.stringify(allPayments));

      alert("Payment updated successfully!");
      cancelForm();
      showHistory();
    }

    function deletePayment() {
      if (selectedStudent === null || selectedPaymentIndex === null) {
        alert("Select a payment from history to delete.");
        return;
      }

      if (!confirm("Are you sure you want to delete this payment?")) return;

      let allPayments = JSON.parse(localStorage.getItem("payments")) || {};
      allPayments[selectedStudent].splice(selectedPaymentIndex, 1);
      localStorage.setItem("payments", JSON.stringify(allPayments));

      alert("Payment deleted.");
      cancelForm();
      showHistory();
    }

    function cancelForm() {
      selectedStudent = null;
      selectedPaymentIndex = null;
      document.querySelectorAll(".form-container input, .form-container select").forEach(el => el.value = "");
    }

    function showHistory() {
      const studentName = document.getElementById("historyStudent").value;
      const allPayments = JSON.parse(localStorage.getItem("payments")) || {};
      const history = allPayments[studentName] || [];

      const container = document.getElementById("paymentHistory");
      container.innerHTML = "";

      if (history.length === 0) {
        container.innerHTML = "<p>No payment history available.</p>";
        return;
      }

      const table = document.createElement("table");
table.classList.add("colorful-table"); // optional, if you want more control

      table.border = "1";
      table.style.width = "100%";

      let header = table.insertRow();
      ["Seat No", "Mobile", "Start Date", "Month", "Due Date",
        "Fees", "Payment Date", "Mode", "Remark"].forEach(h => {
          let th = document.createElement("th");
          th.innerText = h;
          header.appendChild(th);
        });

      history.forEach((p, index) => {
        let row = table.insertRow();
        row.onclick = () => {
          selectedStudent = studentName;
          selectedPaymentIndex = index;
          populateForm(p);
        };

        row.insertCell().innerText = p.seatNumber;
        row.insertCell().innerText = p.mobileNumber;
        row.insertCell().innerText = formatDate(p.startDate);
        row.insertCell().innerText = p.admissionMonth;
        row.insertCell().innerText = formatDate(p.dueDate);
        row.insertCell().innerText = p.fees;
        row.insertCell().innerText = formatDate(p.paymentDate);
        row.insertCell().innerText = p.mode;
        row.insertCell().innerText = p.remark;
      });

      container.appendChild(table);
    }

    function formatMonth(monthNumber) {
      if (!monthNumber) return "";
      const months = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
      const index = parseInt(monthNumber) - 1;
      return months[index] || "";
    }

    function formatDate(dateStr) {
  if (!dateStr) return "-";
  const date = new Date(dateStr);
  if (isNaN(date)) return "-";

  const day = date.getDate().toString().padStart(2, '0');
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  const month = monthNames[date.getMonth()];
  const year = date.getFullYear().toString().slice(2); // last 2 digits

  return `${day}-${month}-${year}`;
}


    function downloadPDF() {
      const studentName = document.getElementById("historyStudent").value;
      const allPayments = JSON.parse(localStorage.getItem("payments")) || {};
      const history = allPayments[studentName] || [];

      if (history.length === 0) {
        alert("No data to download.");
        return;
      }

      const jsPDF = window.jsPDFGlobal;
      if (!jsPDF) {
        alert("PDF generator not ready yet.");
        return;
      }

     const doc = new jsPDF({
  orientation: "landscape",
  unit: "mm",
  format: "a4"
});

      doc.setFontSize(16);
      doc.setTextColor(40, 40, 40);
      doc.text(`Payment History - ${studentName}`, 14, 15);

      const rows = history.map(p => [
        p.seatNumber || "-",
        p.mobileNumber || "-",
        formatDate(p.startDate),
        p.admissionMonth,
        formatDate(p.dueDate),
        p.fees || "-",
        formatDate(p.paymentDate),
        p.mode || "-",
        p.remark || "-"
      ]);

      doc.autoTable({
  head: [["Seat No", "Mobile", "Start Date", "Month", "Due Date", "Fees", "Payment Date", "Mode", "Remark"]],
  body: rows,
  startY: 20,
  theme: 'grid',
  headStyles: {
    fillColor: [63, 81, 181],  // Dark blue
    textColor: [255, 255, 255], // White text
    fontStyle: 'bold',          // Bold header font
    fontSize: 12                // Larger font size for header
  },
  styles: {
    fontSize: 10,               // Slightly bigger font for body
    cellPadding: 4,
    fontStyle: 'bold',          // Make body font bold
    textColor: [30, 30, 30]     // Dark text color for better visibility
  },
  alternateRowStyles: {
    fillColor: [240, 240, 240]  // Light gray background on alternate rows for readability
  },
  columnStyles: {
    8: { cellWidth: 60 }
  }
});


      // ✅ Trigger “Save As…” dialog
  const blob = doc.output("blob");
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${studentName}_payment_history.pdf`; // default filename
  link.click();
}
async function downloadAllPaymentsPDF() {
  const allPayments = JSON.parse(localStorage.getItem("payments")) || {};
  const studentNames = Object.keys(allPayments);

  if (studentNames.length === 0) {
    alert("No payment data available.");
    return;
  }

  const jsPDF = window.jsPDFGlobal;
  if (!jsPDF) {
    alert("PDF generator not ready yet.");
    return;
  }

  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: "a4"
  });

  doc.setFontSize(16);
  doc.setTextColor(40, 40, 40);

  let currentY = 15;

  for (const studentName of studentNames) {
    const payments = allPayments[studentName];

    if (!payments || payments.length === 0) continue;

    // Student heading
    doc.text(`Payment History - ${studentName}`, 14, currentY);

    // Prepare data
    const rows = payments.map(p => [
      p.seatNumber || "-",
      p.mobileNumber || "-",
      formatDate(p.startDate),
      p.admissionMonth,
      formatDate(p.dueDate),
      p.fees || "-",
      formatDate(p.paymentDate),
      p.mode || "-",
      p.remark || "-"
    ]);

    // Table
    doc.autoTable({
      startY: currentY + 5,
      head: [["Seat No", "Mobile", "Start Date", "Month", "Due Date", "Fees", "Payment Date", "Mode", "Remark"]],
      body: rows,
      theme: 'grid',
      styles: {
        fontSize: 10,
        cellPadding: 4,
        fontStyle: 'bold',
        textColor: [30, 30, 30]
      },
      headStyles: {
        fillColor: [63, 81, 181],
        textColor: [255, 255, 255],
        fontStyle: 'bold'
      },
      alternateRowStyles: {
        fillColor: [240, 240, 240]
      },
      columnStyles: {
        8: { cellWidth: 60 }
      },
      didDrawPage: function (data) {
        currentY = data.cursor.y + 10;

        // If the next student won't fit, create a new page
        if (currentY + 50 > doc.internal.pageSize.getHeight()) {
          doc.addPage();
          currentY = 15;
        }
      }
    });
  }

  // ✅ Open PDF in new tab for manual save
  const blob = doc.output("blob");
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
}
async function downloadMonthlyReport(month, year) {
  const allPayments = JSON.parse(localStorage.getItem("payments")) || {};
  const jsPDF = window.jsPDFGlobal;
  if (!jsPDF) {
    alert("PDF generator not ready yet.");
    return;
  }

  const doc = new jsPDF({
    orientation: "landscape",
    unit: "mm",
    format: "a4"
  });

  const pageWidth = doc.internal.pageSize.getWidth();
  const centerX = pageWidth / 2;

  // 🌟 Fancy Centered Header Section
  const title = "Wisdom Library";
  const reportTitle = "Monthly Fees Report";
  const monthYearText = `${getMonthName(month)} ${year}`;
  const generatedDate = new Date().toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "long",
    year: "numeric"
  });

  // 🎨 1️⃣ Main Title
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.setTextColor(0, 102, 204);
  const titleWidth = doc.getTextWidth(title);
  doc.text(title, centerX - titleWidth / 2, 20);
  doc.setDrawColor(0, 102, 204);
  doc.setLineWidth(1);
  doc.line(centerX - titleWidth / 2, 22, centerX + titleWidth / 2, 22);

  // 🧾 2️⃣ Report Title
  doc.setFontSize(18);
  doc.setTextColor(30, 30, 30);
  const rptWidth = doc.getTextWidth(reportTitle);
  doc.text(reportTitle, centerX - rptWidth / 2, 32);
  doc.setDrawColor(30, 30, 30);
  doc.line(centerX - rptWidth / 2, 34, centerX + rptWidth / 2, 34);

  // 📅 3️⃣ Month & Year
  doc.setFontSize(16);
  doc.setTextColor(220, 20, 60);
  doc.setFont("helvetica", "bold");
  const myWidth = doc.getTextWidth(monthYearText);
  doc.text(monthYearText, centerX - myWidth / 2, 44);
  doc.setDrawColor(220, 20, 60);
  doc.line(centerX - myWidth / 2, 46, centerX + myWidth / 2, 46);

  // 🕓 Generated Date (bottom-right corner)
  doc.setFontSize(11);
  doc.setFont("helvetica", "italic");
  doc.setTextColor(100, 100, 100);
  const genText = `Generated on: ${generatedDate}`;
  const genWidth = doc.getTextWidth(genText);
  const pageHeight = doc.internal.pageSize.getHeight();
  doc.text(genText, pageWidth - genWidth - 14, pageHeight - 10);

  // --------------------------
  // Table Data Section
  // --------------------------
  const rows = [];
  let total = 0;

  for (const [studentName, payments] of Object.entries(allPayments)) {
    for (const p of payments) {
      if (!p.paymentDate) continue;
      const date = new Date(p.paymentDate);
      if (date.getMonth() + 1 === month && date.getFullYear() === year) {
        rows.push([
          studentName,
          p.mobileNumber || "-",
          formatDate(p.paymentDate),
          p.admissionMonth || "-", // ✅ New column for Month
          p.fees || "0",
          p.mode || "-",
          p.remark || "-"
        ]);
        total += Number(p.fees) || 0;
      }
    }
  }

  if (rows.length === 0) {
    alert(`No payments found for ${getMonthName(month)} ${year}`);
    return;
  }

  // ✅ Table with "Month" column
  doc.autoTable({
    startY: 55,
    head: [["Student Name", "Mobile", "Payment Date", "Month", "Fees", "Mode", "Remark"]],
    body: rows,
    theme: "grid",
    headStyles: {
      fillColor: [0, 102, 204],
      textColor: [255, 255, 255],
      fontStyle: "bold"
    },
    bodyStyles: {
      fontStyle: "bold",
      textColor: [0, 0, 0],
      fillColor: false,
    },
    styles: {
      fontSize: 10,
      cellPadding: 4,
      lineColor: [180, 180, 180],
      lineWidth: 0.2
    },
columnStyles: {
  3: { halign: "center" } // 0=Student, 1=Mobile, 2=Payment Date, 3=Month
},

    didDrawPage: function (data) {
      const pageHeight = doc.internal.pageSize.getHeight();
      const pageWidth = doc.internal.pageSize.getWidth();

      doc.setFontSize(11);
      doc.setFont("helvetica", "italic");
      doc.setTextColor(100, 100, 100);

      const genText = `Generated on: ${generatedDate}`;
      const genWidth = doc.getTextWidth(genText);
      doc.text(genText, pageWidth - genWidth - 14, pageHeight - 10);
    }
  });

  // ✅ Total at bottom
  const finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(0, 100, 0);
  doc.text(`Total Fees Received: ${total.toLocaleString()}`, 14, finalY);

   // ✅ Open PDF in new tab
  const blob = doc.output("blob");
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
}


// Helper
function getMonthName(month) {
  const months = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  return months[month - 1];
}
function openMonthPicker() {
  const monthInput = document.getElementById("monthPicker");

  // Reset & trigger the calendar
  monthInput.value = "";
  monthInput.style.display = "block";
  monthInput.showPicker?.(); // open month picker directly (Chrome-supported)

  // When user selects a month
  monthInput.onchange = () => {
    const selectedValue = monthInput.value; // format = "2025-09"
    if (!selectedValue) return;

    const [yearStr, monthStr] = selectedValue.split("-");
    const month = parseInt(monthStr);
    const year = parseInt(yearStr);

    monthInput.style.display = "none"; // hide again
    downloadMonthlyReport(month, year);
  };
}




async function backupData() {
  try {
    const allPayments = localStorage.getItem("payments");
    if (!allPayments) {
      alert("No data to backup.");
      return;
    }

    const fileHandle = await window.showSaveFilePicker({
      suggestedName: "student_payments_backup.json",
      types: [{
        description: "JSON File",
        accept: { "application/json": [".json"] }
      }]
    });

    const writable = await fileHandle.createWritable();
    await writable.write(allPayments);
    await writable.close();

    alert("✅ Backup saved successfully!");
  } catch (err) {
    if (err.name !== 'AbortError') {
      alert("❌ Failed to save file.");
      console.error(err);
    }
  }
}

async function restoreData() {
  try {
    const [fileHandle] = await window.showOpenFilePicker({
      types: [{
        description: "JSON File",
        accept: { "application/json": [".json"] }
      }]
    });

    const file = await fileHandle.getFile();
    const text = await file.text();
    const json = JSON.parse(text);

    if (confirm("Are you sure you want to restore this backup? This will overwrite current data.")) {
      localStorage.setItem("payments", JSON.stringify(json));
      alert("✅ Data restored successfully!");
      showHistory(); // Refresh payment history if a student is selected
    }
  } catch (err) {
    if (err.name !== 'AbortError') {
      alert("❌ Failed to restore data.");
      console.error(err);
    }
  }
}
function showShareButtons() {
  document.getElementById("shareOptions").style.display = "block";
}

function hideShareButtons() {
  document.getElementById("shareOptions").style.display = "none";
}
// Move focus to next input on Enter key (auto-click Save on last)
document.addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    const focusableElements = Array.from(
      document.querySelectorAll(
        "input, select, textarea, button:not([disabled])"
      )
    ).filter(el => el.offsetParent !== null); // only visible ones

    const index = focusableElements.indexOf(document.activeElement);

    if (index > -1 && index < focusableElements.length - 1) {
      e.preventDefault(); // stop form submit
      focusableElements[index + 1].focus();
    } else if (index === focusableElements.length - 1) {
      e.preventDefault();
      // Try clicking the save button if found
      const saveBtn = document.querySelector("#saveButton, .save-btn, button[type='submit']");
      if (saveBtn) {
        saveBtn.click();
      }
    }
  }
});
// 🗓️ Auto open calendar when Start Date or Payment Date gets focus
document.addEventListener("DOMContentLoaded", function () {
  const autoOpenDateInputs = ["editAdmissionDate", "editDueDate", "paymentDate", "startDate"];

  autoOpenDateInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener("focus", function () {
        // थोड़ी delay इसलिए ताकि browser input को ready कर ले
        setTimeout(() => {
          this.showPicker?.(); // ✅ Modern browsers (Chrome, Edge)
        }, 100);
      });
    }
  });
});


  </script>
</body>
</html>



